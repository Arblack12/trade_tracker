{% load static %}
{% load humanize %}       {# for intcomma #}
{% load extra_filters %}  {# Load if you use divide/multiply, otherwise optional #}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Tracker Main</title>

    {# --- Bootstrap CSS --- #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    {# --- Your Custom CSS Link --- #}
    <link rel="stylesheet" href="{% static 'trades/css/dark_theme.css' %}">

    {# --- Your Inline Styles --- #}
    <style>
        /* --- Keep your original styles --- */
        body { /* Apply dark theme styles to body if not extending */
             background-color: #1a1a1a;
             color: #e0e0e0;
             font-family: sans-serif; /* Basic font */
             margin: 0; /* Remove default margin */
             padding: 15px; /* Add some padding */
        }
        .container { /* Optional container for centering/max-width */
             max-width: 1400px; /* Adjust as needed */
             margin: 0 auto; /* Center the content */
        }
        a { color: #66bfff; text-decoration: none; } /* Basic link styling */
        a:hover { text-decoration: underline; }
        button { /* Basic button styling */
            background-color: #008c5f; color: #fff; padding: 8px 15px;
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        button:hover { background-color: #00a874; }
        input[type="text"], input[type="number"], input[type="date"], select {
             background-color: #333; color: #eee; border: 1px solid #555; padding: 6px; border-radius: 3px;

        }
        .top-row button { /* Target buttons specifically within the top-row div */
            padding: 6px 12px;   /* Reduce padding (original was 8px 15px) */
            font-size: 0.85em;
        }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid #555; padding: 8px; text-align: left; }
        thead th { background-color: #333; }
        tbody tr:nth-child(even) { background-color: #282828; }

        .top-nav { margin-bottom: 20px; }
        .top-nav .nav-buttons {
            list-style: none; display: flex; gap: 10px; padding: 0; margin: 0; flex-wrap: wrap; /* Added wrap */
        }
        .top-nav .nav-buttons li a { /* Style nav links like buttons */
            background-color: #008c5f; color: #fff; padding: 10px 20px;
            text-decoration: none; border-radius: 4px; font-weight: bold;
            display: inline-block;
        }
        .top-nav .nav-buttons li a:hover {
            background-color: #00a874;
        }
        .top-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .content-row {
            display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .left-panel, .right-panel {
             border: 1px solid #444; padding: 15px;
             flex-basis: 100%; /* Default to full width on small screens */
        }
         @media (min-width: 992px) { /* On larger screens, side-by-side */
             .left-panel, .right-panel {
                 flex: 1; /* Take equal space */
             }
         }
        .item-image {
            max-width: 150px;
            max-height: 150px;
            margin-bottom: 10px; display: block; margin-left: auto; margin-right:auto;
        }
        .field-label {
            font-weight: bold;
            width: 150px;
            display: inline-block;
            margin-right: 5px;
        }
        .field-value { display: inline; }
        .info-row p { margin-bottom: 0.5rem; }

        .accum-target-form {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px; flex-wrap: wrap;
        }
        .accum-target-form label { width: 150px; flex-shrink: 0; }
        .accum-target-form input[type="number"] { width: 100px; }
        .accum-target-form button { padding: 6px 12px; font-size: 0.9em; } /* Smaller update buttons */

        .transaction-form-section { margin-top: 20px; }
        .transaction-form-section h3 { margin-bottom: 10px; }
        .transaction-form-section form div { margin-bottom: 8px; }
        .transaction-form-section label { display: block; margin-bottom: 3px; font-weight: bold; }
        .transaction-form-section input[type="text"],
        .transaction-form-section input[type="number"],
        .transaction-form-section input[type="date"],
        .transaction-form-section select {
             width: 100%;
             padding: 6px;
             box-sizing: border-box;
             background-color: #333; color: #eee; border: 1px solid #555;
        }
        .transaction-form-section button { margin-top: 10px; }

        .action-buttons form, .action-buttons a {
            display: inline-block; margin-right: 5px;
        }
        .action-buttons button { /* Style delete button like a link */
             background: none; border: none; color: #ff4d4d; cursor: pointer; padding: 0; text-decoration: underline; font-size: inherit; /* Inherit font size */
        }
         .action-buttons button:hover { color: #ff8080;}
         .action-buttons a { color: #66bfff; }
         .action-buttons a:hover { color: #99d6ff; }

        .pagination { margin-top: 15px; text-align: center; /* Center pagination */ }
        .pagination a { margin: 0 5px; }
        .pagination .current-page { margin: 0 10px; font-weight: bold; }

        /* --- Bootstrap Alert Styling Integration --- */
        /* Inherit font color for alerts from body */
        .alert { color: inherit; }
        /* Specific overrides if needed */
        .alert-success { background-color: #198754; color: white; } /* Ensure text contrast */
        .alert-danger { background-color: #dc3545; color: white; }
        .alert-warning { background-color: #ffc107; color: black; }
        .alert-info { background-color: #0dcaf0; color: black; }
        /* Style the close button for dark theme */
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

    </style>
</head>
<body>
<div class="container">

    {# --- Display Django Messages (Using Bootstrap Alert Structure) --- #}
    <div class="messages-container mx-auto" style="position: sticky; top: 0; z-index: 1050; max-width: 700px; /* Adjust max-width as desired */ margin-bottom: 1rem;">
      {% if messages %}
          {% for message in messages %}
              {# --- Map Django message tags to Bootstrap alert classes --- #}
              {% with bootstrap_tag=message.tags|lower %}
                  {% if 'error' in bootstrap_tag or 'danger' in bootstrap_tag %}
                      {% with alert_class='alert-danger' %}
                          <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert" style="margin-bottom: 2px; border-radius: 0;">
                              {{ message }}
                              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>
                      {% endwith %}
                  {% elif 'success' in bootstrap_tag %}
                      {% with alert_class='alert-success' %}
                          <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert" style="margin-bottom: 2px; border-radius: 0;">
                              {{ message }}
                              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>
                      {% endwith %}
                  {% elif 'warning' in bootstrap_tag %}
                      {% with alert_class='alert-warning' %}
                           <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert" style="margin-bottom: 2px; border-radius: 0;">
                              {{ message }}
                              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>
                      {% endwith %}
                  {% else %} {# Default to info #}
                      {% with alert_class='alert-info' %}
                           <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert" style="margin-bottom: 2px; border-radius: 0;">
                              {{ message }}
                              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                          </div>
                      {% endwith %}
                  {% endif %}
              {% endwith %} {# bootstrap_tag #}
          {% endfor %}
      {% endif %} {# if messages #}
    </div>
    {# --- End Django Messages --- #}

    {# --- NAV BAR (Your Original Structure) --- #}
    <div class="top-nav">
        <ul class="nav-buttons">
            <li><a href="{% url 'trades:index' %}">Home</a></li>
            <li><a href="{% url 'trades:alias_list' %}">Aliases</a></li>
            <li><a href="{% url 'trades:membership_list' %}">Membership</a></li>
            <li><a href="{% url 'trades:wealth_list' %}">Wealth</a></li>
            <li><a href="{% url 'trades:watchlist_list' %}">Watchlist</a></li>
            <li><a href="{% url 'trades:recent_trades' %}">Recent trades</a></li>

            {% if user.is_authenticated %}
                <li><a href="{% url 'trades:account_page' %}">{{ user.username }}</a></li>
                {# Logout Form Button #}
                <li>
                     <form action="{% url 'trades:logout_view' %}" method="post" style="display: inline;">
                         {% csrf_token %}
                         <button type="submit" style="background: none; border: none; padding: 0; margin: 0;">
                            {# Apply button styling directly to the link inside #}
                            <a style="background-color: #dc3545; color: #fff; padding: 10px 20px; text-decoration: none; border-radius: 4px; font-weight: bold; display: inline-block;">Logout</a>
                         </button>
                     </form>
                 </li>
            {% else %}
                <li><a href="{% url 'trades:login_view' %}">Login/Signup</a></li> {# Combined Login/Signup #}
            {% endif %}

             {% if user.is_staff %} {# Staff only link #}
              <li><a href="{% url 'trades:user_management' %}" style="background-color: #ffc107; color: #333;">Manage Users</a></li>
             {% endif %}
        </ul>
    </div>
    {# --- END NAV BAR --- #}

    {# --- TOP ROW: search, timeframe, and chart buttons --- #}
    <div class="top-row">
        <form method="get" action="." style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
             <label for="id_search">Search Item:</label>
            <input type="text" id="id_search" name="search" placeholder="Item short or full name" value="{{ search_query|default:'' }}">

            {# Keep timeframe if you use it, otherwise remove #}
            <label for="id_timeframe">Time Frame:</label>
            <select id="id_timeframe" name="timeframe">
                <option {% if timeframe == "Daily" %}selected{% endif %}>Daily</option>
                <option {% if timeframe == "Monthly" %}selected{% endif %}>Monthly</option>
                <option {% if timeframe == "Yearly" %}selected{% endif %}>Yearly</option>
            </select>

            <button type="submit">Search</button>
        </form>

        {# --- Chart Buttons --- #}
        <a href="{% url 'trades:global_profit_chart' %}?timeframe={{ timeframe|default:'Daily'|urlencode }}">
            <button>Global Profit Chart</button>
        </a>

        {% if item %} {# Check if item context exists before showing item-specific buttons #}
            <a href="{% url 'trades:item_price_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}" style="margin-left:10px;">
                <button>Generate Price Chart</button>
            </a>
            <a href="{% url 'trades:item_profit_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}" style="margin-left:10px;">
                <button>Generate Profit Chart</button>
            </a>
        {% endif %}
    </div>

    {# --- Main Content Area --- #}
    <div class="content-row">
        {# --- LEFT PANEL: item image & info --- #}
        <div class="left-panel">
             {% if item %} {# Only show if an item is found #}
                <div style="text-align:center;">
                    {% if item_image_url %}
                    <img src="{{ item_image_url }}" alt="{{ item.name }} Image" class="item-image">
                    {% else %}
                     <img src="{% static 'images/rs3_logo.webp' %}" alt="Default Image" class="item-image" style="opacity: 0.5;">
                    {% endif %}
                    <h2>{{ item.name }}</h2>
                </div>
                <div class="info-row">
                    <p><span class="field-label">Accumulation Price:</span> <span class="field-value">{% if accumulation %} {{ accumulation.accumulation_price|floatformat:0|intcomma }} {% else %} 0 {% endif %}</span></p>
                    <p><span class="field-label">Target Sell Price:</span> <span class="field-value">{% if target_sell %} {{ target_sell.target_sell_price|floatformat:0|intcomma }} {% else %} 0 {% endif %}</span></p>
                    <p><span class="field-label">Average Sell Price:</span> <span class="field-value">{{ average_sold_price|floatformat:0|intcomma }}</span></p>
                    <p><span class="field-label">Total Sold:</span> <span class="field-value">{{ total_sold|floatformat:0|intcomma }}</span></p>
                    <p><span class="field-label">Quantity Held:</span> <span class="field-value">{{ remaining_quantity|floatformat:0|intcomma }}</span></p>
                    <p><span class="field-label">Item Realised Profit:</span> <span class="field-value">{{ item_profit|floatformat:0|intcomma }}</span></p>
                    <p><span class="field-label">Global Realised Profit:</span> <span class="field-value">{{ global_realised_profit|floatformat:0|intcomma }}</span></p>
                    <p><span class="field-label">Last Tx Date:</span>
                       <span class="field-value">
                       {% with first_trans=page_obj.object_list.0 %}
                          {% if first_trans %}{{ first_trans.date_of_holding|date:"Y-m-d" }}{% else %}-{% endif %}
                       {% endwith %}
                       </span>
                   </p>
                 </div>
            {% else %}
                 <div style="text-align:center;">
                      <img src="{% static 'images/rs3_logo.webp' %}" alt="Default Image" class="item-image" style="opacity: 0.5;">
                      <h2>Search Item</h2>
                      <p>Enter an item name or alias above to see details and transaction history.</p>
                      <p><span class="field-label">Global Realised Profit:</span> <span class="field-value">{{ global_realised_profit|floatformat:0|intcomma }}</span></p>
                 </div>
            {% endif %}
        </div>

        {# --- RIGHT PANEL: forms + add/edit transaction --- #}
        <div class="right-panel">
            {% if item %}
                <form method="post" class="accum-target-form">
                    {% csrf_token %}
                    <input type="hidden" name="acc_item_id" value="{{ item.id }}">
                    <input type="hidden" name="search_query_hidden" value="{{ search_query|default:'' }}">
                    {% if page_obj.number %}<input type="hidden" name="page_hidden" value="{{ page_obj.number }}">{% endif %}
                    <label for="acc_price">Accumulation Price (M):</label>
                    {# Display/edit price in millions #}
                    <input type="number" step="any" name="accumulation_price" id="acc_price" value="{% if accumulation %}{{ accumulation.accumulation_price|divide:1000000|default_if_none:''|floatformat:'-3g' }}{% endif %}">
                    <button type="submit" name="update_accumulation">Update</button>
                </form>

                <form method="post" class="accum-target-form">
                    {% csrf_token %}
                    <input type="hidden" name="ts_item_id" value="{{ item.id }}">
                    <input type="hidden" name="search_query_hidden" value="{{ search_query|default:'' }}">
                    {% if page_obj.number %}<input type="hidden" name="page_hidden" value="{{ page_obj.number }}">{% endif %}
                    <label for="ts_price">Target Sell Price (M):</label>
                    {# Display/edit price in millions #}
                    <input type="number" step="any" name="target_sell_price" id="ts_price" value="{% if target_sell %}{{ target_sell.target_sell_price|divide:1000000|default_if_none:''|floatformat:'-3g' }}{% endif %}">
                    <button type="submit" name="update_target_sell">Update</button>
                </form>
            {% endif %}

            {# --- Add/Edit Transaction Form Section --- #}
             <div class="transaction-form-section">
                 {% if edit_form %}
                    {# --- EDIT FORM --- #}
                     <h3>Edit Transaction (ID: {{ edit_form.initial.transaction_id }})</h3>
                     <form method="post">
                         {% csrf_token %}
                         <input type="hidden" name="search_query_hidden" value="{{ search_query|default:'' }}">
                         {% if page_obj.number %}<input type="hidden" name="page_hidden" value="{{ page_obj.number }}">{% endif %}
                         {{ edit_form.transaction_id }} {# Hidden ID field #}
                         <div><label for="{{ edit_form.item_name.id_for_label }}">{{ edit_form.item_name.label }}:</label> {{ edit_form.item_name }}</div>
                         <div><label for="{{ edit_form.trans_type.id_for_label }}">{{ edit_form.trans_type.label }}:</label> {{ edit_form.trans_type }}</div>
                         <div><label for="{{ edit_form.price.id_for_label }}">{{ edit_form.price.label }} (M):</label> {{ edit_form.price }}</div>
                         <div><label for="{{ edit_form.quantity.id_for_label }}">{{ edit_form.quantity.label }}:</label> {{ edit_form.quantity }}</div>
                         <div><label for="{{ edit_form.date_of_holding.id_for_label }}">{{ edit_form.date_of_holding.label }}:</label> {{ edit_form.date_of_holding }}</div>
                         {% if edit_form.errors %}<div style="color: #ff4d4d; margin-top: 10px;"><strong>Errors:</strong> {{ edit_form.errors }}</div>{% endif %}
                         <button type="submit" name="update_transaction">Update Transaction</button>
                          <a href="{% url 'trades:index' %}?search={{ search_query|urlencode }}{% if page_obj.number %}&page={{ page_obj.number }}{% endif %}" style="margin-left: 10px;">Cancel</a>
                     </form>
                 {% else %}
                     {# --- ADD FORM --- #}
                     <h3>Add Transaction</h3>
                     <form method="post">
                         {% csrf_token %}
                         <input type="hidden" name="search_query_hidden" value="{{ search_query|default:'' }}">
                         {% if page_obj.number %}<input type="hidden" name="page_hidden" value="{{ page_obj.number }}">{% endif %}
                         <div><label for="{{ transaction_form.item_name.id_for_label }}">{{ transaction_form.item_name.label }}:</label> {{ transaction_form.item_name }}</div>
                         <div><label for="{{ transaction_form.trans_type.id_for_label }}">{{ transaction_form.trans_type.label }}:</label> {{ transaction_form.trans_type }}</div>
                         <div><label for="{{ transaction_form.price.id_for_label }}">{{ transaction_form.price.label }} (M):</label> {{ transaction_form.price }}</div>
                         <div><label for="{{ transaction_form.quantity.id_for_label }}">{{ transaction_form.quantity.label }}:</label> {{ transaction_form.quantity }}</div>
                         <div><label for="{{ transaction_form.date_of_holding.id_for_label }}">{{ transaction_form.date_of_holding.label }}:</label> {{ transaction_form.date_of_holding }}</div>
                         {% if transaction_form.errors %}<div style="color: #ff4d4d; margin-top: 10px;"><strong>Errors:</strong> {{ transaction_form.errors }}</div>{% endif %}
                         <button type="submit" name="add_transaction">Add Transaction</button>
                     </form>
                 {% endif %}
             </div>
        </div> {# End right-panel #}
    </div> {# End content-row #}

    {# --- TRANSACTIONS TABLE --- #}
    <h2>Transactions History {% if item %}- {{ item.name }}{% endif %}</h2>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Date</th>
                    <th>User</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for t in page_obj %} {# Loop through paginated items #}
                <tr>
                    <td>{{ t.id }}</td>
                    <td>{{ t.item.name }}</td>
                    <td>{{ t.trans_type }}</td>
                    <td>{{ t.price|floatformat:0|intcomma }}</td>
                    <td>{{ t.quantity|floatformat:0|intcomma }}</td>
                    <td>{{ t.date_of_holding|date:"Y-m-d" }}</td>
                    <td>{% if t.user %} {{ t.user.username }} {% else %} Unknown {% endif %}</td>
                    <td class="action-buttons">
                        {% if t.user == user %}
                            <a href="{% url 'trades:index' %}?search={{ search_query|urlencode }}&edit_trans={{ t.id }}{% if page_obj.number %}&page={{ page_obj.number }}{% endif %}">Edit</a> |
                            <form method="post" style="display:inline;" onsubmit="return confirm('Delete transaction ID {{ t.id }}?');">
                                {% csrf_token %}
                                <input type="hidden" name="transaction_id" value="{{ t.id }}">
                                <input type="hidden" name="search_query_hidden" value="{{ search_query|default:'' }}">
                                {% if page_obj.number %}<input type="hidden" name="page_hidden" value="{{ page_obj.number }}">{% endif %}
                                <button type="submit" name="delete_transaction">Delete</button>
                            </form>
                        {% else %} N/A {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="8" style="text-align: center;">No transactions found{% if search_query %} for '{{ search_query }}'{% endif %}.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>

    {# --- Pagination Controls FIXED --- #}
    <div class="pagination">
        {% if page_obj.has_other_pages %}
            <span class="step-links">
                {% if page_obj.has_previous %}
                    <a href="?search={{ search_query|urlencode }}&page=1">&laquo; first</a>
                    <a href="?search={{ search_query|urlencode }}&page={{ page_obj.previous_page_number }}">previous</a>
                {% endif %}

                <span class="current-page"> Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }} </span>

                {% if page_obj.has_next %}
                    <a href="?search={{ search_query|urlencode }}&page={{ page_obj.next_page_number }}">next</a>
                    <a href="?search={{ search_query|urlencode }}&page={{ page_obj.paginator.num_pages }}">last &raquo;</a>
                {% endif %}
            </span>
        {% endif %}
    </div>

    {# --- Embedded Charts --- #}
    {% if item %}
        <hr style="border-color: #444;">
        <div style="text-align: center;">
            <h2>Buy/Sell Price Chart (Embedded)</h2>
            <img src="{% url 'trades:item_price_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}"
                 alt="Buy-Sell Price Chart" style="max-width:100%; height: auto; border: 1px solid #444; margin-bottom: 20px;">

            <h2>Item Cumulative Profit (Embedded)</h2>
            <img src="{% url 'trades:item_profit_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}"
                 alt="Item Profit Chart" style="max-width:100%; height: auto; border: 1px solid #444;">
        </div>
    {% endif %}

</div> {# End container #}

    {# --- Bootstrap JavaScript Bundle (Needed for alert dismissal AND the auto-close script) --- #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    {# --- Add this Custom JavaScript for Auto-Dismissing Alerts --- #}
    <script>
        // Wait for the full page to load
        window.addEventListener('load', function() {
            // Select all alert elements that have the dismissible class
            const autoDismissAlerts = document.querySelectorAll('.alert.alert-dismissible');

            // Set the timeout duration in milliseconds (e.g., 5000ms = 5 seconds)
            const dismissTimeout = 5000;

            autoDismissAlerts.forEach(function(alertElement) {
                // Set a timer for each alert
                setTimeout(function() {
                    // Use Bootstrap's built-in Alert instance to trigger the close method
                    // This ensures the fade-out animation works correctly
                    const alertInstance = bootstrap.Alert.getOrCreateInstance(alertElement);
                    if (alertInstance) {
                        alertInstance.close(); // Trigger the close method
                    }
                    // If Bootstrap JS failed, this would be a less graceful fallback:
                    // else { alertElement.style.display = 'none'; }
                }, dismissTimeout);
            });
        });
    </script>
    {# --- End Custom JavaScript --- #}

</body>
</html>