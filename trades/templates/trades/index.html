{% comment %} trades/templates/trades/index.html {% endcomment %}
{% load static %}
{% load humanize %}      {# for intcomma #}
{% load extra_filters %} {# Load the filters including divide, multiply, subtract #}
{% load query_transform %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Trade Tracker</title>

    {# --- Bootstrap CSS --- #}
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-9ndCyUaIbzAi2FUVXJi0CjmCapSmO7SnpJef0486qhLnuZ2cdeRhO02iuK6FUUVM" crossorigin="anonymous">

    {# --- Your Custom CSS Link --- #}
    <link rel="stylesheet" href="{% static 'trades/css/dark_theme.css' %}">

    {# --- Inline Styles (Merged & Enhanced) --- #}
    <style>
        /* --- Base Dark Theme Adjustments --- */
        body {
            background-color: #1a1a1a;
            color: #e0e0e0;
            font-family: sans-serif;
            margin: 0;
            padding: 15px;
        }
        .container {
            max-width: 1600px; /* Wider container for more content */
            margin: 0 auto;
        }
        a { color: #66bfff; text-decoration: none; }
        a:hover { text-decoration: underline; }
        button, input[type="submit"] {
            background-color: #008c5f; color: #fff; padding: 8px 15px;
            border: none; border-radius: 4px; cursor: pointer; font-weight: bold;
        }
        button:hover, input[type="submit"]:hover { background-color: #00a874; }
        input[type="text"], input[type="number"], input[type="date"], select {
            background-color: #333; color: #eee; border: 1px solid #555; padding: 6px; border-radius: 3px;
        }
        table { width: 100%; border-collapse: collapse; margin-bottom: 15px; }
        th, td { border: 1px solid #555; padding: 8px; text-align: left; vertical-align: middle; }
        thead th { background-color: #333; }
        tbody tr:nth-child(even) { background-color: #282828; }

        /* --- Navigation --- */
        .top-nav { margin-bottom: 20px; }
        .top-nav .nav-buttons {
            list-style: none; display: flex; gap: 10px; padding: 0; margin: 0; flex-wrap: wrap;
        }
        .top-nav .nav-buttons li a {
            background-color: #008c5f; color: #fff; padding: 10px 20px;
            text-decoration: none; border-radius: 4px; font-weight: bold;
            display: inline-block;
        }
        .top-nav .nav-buttons li a:hover { background-color: #00a874; }
        .top-nav .nav-buttons form button a { /* Make logout button visually consistent */
             background-color: #dc3545 !important; /* Red for logout */
             color: #fff !important; padding: 10px 20px; text-decoration: none;
             border-radius: 4px; font-weight: bold; display: inline-block;
        }
         .top-nav .nav-buttons form button a:hover { background-color: #bb2d3b !important; }
         .top-nav .nav-buttons form button { /* Reset underlying button style */
             background: none; border: none; padding: 0; margin: 0; cursor: pointer;
         }

        /* --- Top Row (Search, Timeframe, Charts) --- */
        .top-row {
            display: flex; align-items: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .top-row button { /* Smaller buttons in top row */
            padding: 6px 12px;
            font-size: 0.85em;
        }
        .top-row form { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; }

        /* --- Main Content Layout (Left/Right Panels) --- */
        .content-row {
            display: flex; gap: 20px; margin-bottom: 20px; flex-wrap: wrap;
        }
        .left-panel, .right-panel {
            border: 1px solid #444; padding: 15px; border-radius: 5px;
            background-color: #222; /* Slightly different background for panels */
            flex-basis: 100%; /* Default to full width */
        }
        @media (min-width: 1200px) { /* Adjust breakpoint as needed */
             .left-panel { flex: 0 0 30%; } /* Fixed width for left */
             .right-panel { flex: 1; } /* Right takes remaining space */
        }
        @media (min-width: 992px) and (max-width: 1199px) { /* Medium screens */
             .left-panel { flex: 0 0 40%; }
             .right-panel { flex: 1; }
        }

        /* --- Left Panel (Item Info) --- */
        .item-image {
            max-width: 150px; max-height: 150px; margin-bottom: 10px;
            display: block; margin-left: auto; margin-right:auto; border-radius: 4px;
        }
        .field-label {
            font-weight: bold; width: 170px; /* Increased width slightly more */
            display: inline-block; margin-right: 5px; vertical-align: top; /* Align top for multi-line values */
        }
        .field-value { display: inline-block; vertical-align: top; } /* Align top */
        .info-row p { margin-bottom: 0.6rem; line-height: 1.4; } /* Slightly more space and line height */
        .accum-target-form {
            display: flex; align-items: center; gap: 8px;
            margin-bottom: 10px; flex-wrap: wrap;
        }
        .accum-target-form label { width: 170px; flex-shrink: 0; } /* Match field-label */
        .accum-target-form input[type="number"] { width: 100px; }
        .accum-target-form button { padding: 6px 12px; font-size: 0.9em; }

        /* Style for the "Last Hit" timestamp */
        .last-hit-time {
            font-size: 0.8em;
            color: #aaa;
            margin-left: 8px; /* Space between price and timestamp */
        }

        /* Style for potential profit */
        .potential-profit-value {
            font-weight: bold;
        }
        .profit-positive { color: #4CAF50; } /* Green */
        .profit-negative { color: #f44336; } /* Red */

        /* --- Right Panel (Forms) --- */
        .form-switcher { margin-bottom: 15px; display: flex; gap: 10px; }
        .form-container { display: none; /* Initially hide all forms */ }
        .form-container.active { display: block; /* Show active form */ }

        .transaction-form-section h3 { margin-bottom: 15px; border-bottom: 1px solid #444; padding-bottom: 5px;}
        .transaction-form-section form div { margin-bottom: 10px; }
        .transaction-form-section label { display: block; margin-bottom: 4px; font-weight: bold; }
        .transaction-form-section input[type="text"],
        .transaction-form-section input[type="number"],
        .transaction-form-section input[type="date"],
        .transaction-form-section select {
            width: 100%; padding: 6px; box-sizing: border-box;
        }
        /* Buttons for Transaction Type */
        .trans-type-buttons { margin-bottom: 15px; display: flex; gap: 10px; flex-wrap: wrap; }
        .trans-type-buttons button {
            padding: 8px 12px; font-size: 0.9em;
            border: 1px solid #555; /* Add border */
            opacity: 0.7; /* Default dim */
        }
         .trans-type-buttons button.selected {
            opacity: 1.0; /* Full opacity when selected */
            border-width: 2px; /* Highlight selected */
            box-shadow: 0 0 5px rgba(255, 255, 255, 0.3);
        }
        .btn-buy { background-color: #198754; border-color: #13653f !important; } /* Green */
        .btn-sell { background-color: #dc3545; border-color: #b02a37 !important; } /* Red */
        .btn-buy:hover { background-color: #157347; }
        .btn-sell:hover { background-color: #b02a37; }

        .submit-section button { width: 100%; padding: 10px; font-size: 1.1em; margin-top: 10px;}

        /* --- Tables & Actions --- */
         h2 { margin-top: 25px; border-bottom: 1px solid #555; padding-bottom: 5px;}
        .action-buttons form, .action-buttons a {
            display: inline-block; margin-right: 5px; vertical-align: middle;
        }
        .action-buttons button { /* Style delete button like a link */
            background: none; border: none; color: #ff4d4d; cursor: pointer;
            padding: 0; text-decoration: underline; font-size: inherit; /* Inherit font size */
            line-height: 1; /* Align better with text */
        }
        .action-buttons button:hover { color: #ff8080;}
        .action-buttons a { color: #66bfff; }
        .action-buttons a:hover { color: #99d6ff; }

        /* --- Pagination --- */
        .pagination { margin-top: 15px; text-align: center; }
        .pagination .step-links a { margin: 0 5px; }
        .pagination .current-page { margin: 0 10px; font-weight: bold; }

        /* --- Alerts --- */
        .messages-container {
            position: sticky; top: 0; z-index: 1050;
            max-width: 700px; margin-left: auto; margin-right: auto;
            margin-bottom: 1rem;
        }
        .alert { color: inherit; margin-bottom: 2px; border-radius: 0; }
        .alert-success { background-color: #198754; color: white; }
        .alert-danger { background-color: #dc3545; color: white; }
        .alert-warning { background-color: #ffc107; color: black; }
        .alert-info { background-color: #0dcaf0; color: black; }
        .btn-close { filter: invert(1) grayscale(100%) brightness(200%); }

        /* --- Charts --- */
        .chart-container img {
            max-width:100%; height: auto; border: 1px solid #444; margin-bottom: 20px; border-radius: 4px;
         } /* Closing brace was missing */
         .filter-buttons { margin-bottom: 10px; display: flex; gap: 10px; align-items: center; flex-wrap: wrap;}
         .filter-buttons h2 { margin: 0; margin-right: 10px; /* Adjust spacing */ font-size: 1.4em; border: none; padding: 0;} /* Style heading */
         .filter-buttons a button { /* Style button links */
             padding: 5px 10px;
             font-size: 0.9em;
             background-color: #444; /* Default button color */
             border: 1px solid #666;
             color: #eee;
             cursor: pointer;
         }
         .filter-buttons a button.active { /* Style for active button */
             background-color: #008c5f; /* Active color */
             border-color: #00a874;
             font-weight: bold;
         }
          .filter-buttons a button:hover {
              background-color: #555; /* Hover for inactive */
          }
           .filter-buttons a button.active:hover {
              background-color: #00a874; /* Hover for active */
          }

          /* Style for transaction date/time */
          td.transaction-time {
              white-space: nowrap; /* Prevent wrapping */
              font-size: 0.9em; /* Slightly smaller */
              color: #bbb; /* Dimmer color */
          }

    </style>
</head>
<body>
<div class="container">

    {# --- Display Django Messages (Using Bootstrap Alert Structure) --- #}
    <div class="messages-container">
        {% if messages %}
            {% for message in messages %}
                {# --- Map Django messa   ge tags to Bootstrap alert classes --- #}
                {% with bootstrap_tag=message.tags|lower %}
                    {% if 'error' in bootstrap_tag or 'danger' in bootstrap_tag %}
                        {% with alert_class='alert-danger' %}
                            <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endwith %}
                    {% elif 'success' in bootstrap_tag %}
                        {% with alert_class='alert-success' %}
                             <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endwith %}
                    {% elif 'warning' in bootstrap_tag %}
                         {% with alert_class='alert-warning' %}
                             <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endwith %}
                    {% else %} {# Default to info #}
                         {% with alert_class='alert-info' %}
                             <div class="alert {{ alert_class }} alert-dismissible fade show" role="alert">
                                {{ message }}
                                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                            </div>
                        {% endwith %}
                    {% endif %}
                {% endwith %} {# bootstrap_tag #}
            {% endfor %}
        {% endif %} {# if messages #}
    </div>
    {# --- End Django Messages --- #}

    {# --- NAV BAR --- #}
    <div class="top-nav">
        <ul class="nav-buttons">
            <li><a href="{% url 'trades:index' %}">Home</a></li>
            <li><a href="{% url 'trades:alias_list' %}">Aliases</a></li>
            <li><a href="{% url 'trades:membership_list' %}">Membership</a></li>
            <li><a href="{% url 'trades:wealth_list' %}">Wealth</a></li>
            <li><a href="{% url 'trades:watchlist_list' %}">Watchlist</a></li>
            <li><a href="{% url 'trades:recent_trades' %}">Recent trades</a></li>

            {% if user.is_authenticated %}
                <li><a href="{% url 'trades:account_page' %}">{{ user.username }}</a></li>
                {# Logout Form Button #}
                <li>
                    <form action="{% url 'trades:logout_view' %}" method="post" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit"><a>Logout</a></button> {# Styled by CSS #}
                    </form>
                </li>
            {% else %}
                <li><a href="{% url 'trades:login_view' %}">Login/Signup</a></li> {# Combined Login/Signup #}
            {% endif %}

             {% if user.is_staff %} {# Staff only link #}
                 <li><a href="{% url 'trades:user_management' %}" style="background-color: #ffc107; color: #333;">Manage Users</a></li>
             {% endif %}
        </ul>
    </div>
    {# --- END NAV BAR --- #}

    {# --- TOP ROW: search, timeframe, and chart buttons --- #}
    <div class="top-row">
        <form method="get" action=".">
            <label for="id_search">Search Item:</label>
            <input type="text" id="id_search" name="search" placeholder="Item short or full name" value="{{ search_query|default:'' }}">

            <label for="id_timeframe">Time Frame:</label>
            <select id="id_timeframe" name="timeframe">
                <option {% if timeframe == "Daily" %}selected{% endif %}>Daily</option>
                <option {% if timeframe == "Monthly" %}selected{% endif %}>Monthly</option>
                <option {% if timeframe == "Yearly" %}selected{% endif %}>Yearly</option>
            </select>

            <button type="submit">Search</button>
        </form>

        {# --- Chart Buttons --- #}
        <a href="{% url 'trades:global_profit_chart' %}?timeframe={{ timeframe|default:'Daily'|urlencode }}">
            <button>Global Profit Chart</button>
        </a>

        {% if item %} {# Check if item context exists before showing item-specific buttons #}
            <a href="{% url 'trades:item_price_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}" style="margin-left:10px;">
                <button>Generate Price Chart</button>
            </a>
            <a href="{% url 'trades:item_profit_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}" style="margin-left:10px;">
                <button>Generate Profit Chart</button>
            </a>
        {% endif %}
    </div>

{# --- Main Content Area --- #}
    <div class="content-row"> {# <--- START content-row --> #}

        {# --- LEFT PANEL --- #}
        <div class="left-panel"> {# <--- START left-panel --> #}
            {% if item %}
                {# === All the content for the left panel when an item exists === #}

                {# Item image and title (Remains centered) #}
                <div style="text-align:center;">
                    {% if item_image_url %}
                    <img src="{{ item_image_url }}" alt="{{ item.name }} Image" class="item-image">
                    {% else %}
                    <img src="{% static 'images/rs3_logo.webp' %}" alt="Default Image" class="item-image" style="opacity: 0.5;">
                    {% endif %}
                    <h2>{{ item.name }}</h2>
                </div>

                {# --- NEW Centered Accumulation/Target/Profit/LastTx Section --- #}
                <div class="price-target-section" style="text-align: center; margin-top: 15px; padding-top: 10px; border-top: 1px solid #444;">

                    {# Accumulation Price #}
                    <div style="margin-bottom: 10px;">
                        <span style="display: block; font-weight: bold; color: #ccc;">Accumulation Price:</span>
                        <span style="display: block;">
                            {% if accumulation %} {{ accumulation.accumulation_price|floatformat:0|intcomma }} {% else %} 0 {% endif %}
                            {% if last_acc_hit_time %}
                                <span class="last-hit-time" style="display: inline; margin-left: 5px;">(Last hit: {{ last_acc_hit_time|naturaltime }})</span>
                            {% endif %}
                        </span>
                    </div>

                    {# Target Sell Price #}
                    <div style="margin-bottom: 10px;">
                         <span style="display: block; font-weight: bold; color: #ccc;">Target Sell Price:</span>
                         <span style="display: block;">
                             {% if target_sell %} {{ target_sell.target_sell_price|floatformat:0|intcomma }} {% else %} 0 {% endif %}
                              {% if last_target_hit_time %}
                                 <span class="last-hit-time" style="display: inline; margin-left: 5px;">(Last hit: {{ last_target_hit_time|naturaltime }})</span>
                              {% endif %}
                         </span>
                    </div>

                    {# Potential Profit #}
                    {% if accumulation and target_sell and accumulation.accumulation_price > 0 and target_sell.target_sell_price > 0 %}
                        {% with sale_price=target_sell.target_sell_price acc_price=accumulation.accumulation_price %}
                            {% with sale_after_tax=sale_price|multiply:0.98 %} {# Apply 2% tax (multiply by 0.98) #}
                                {% with net_profit=sale_after_tax|subtract:acc_price %}
                                    <div style="margin-bottom: 10px;">
                                        <span style="display: block; font-weight: bold; color: #ccc;">Potential Profit Each Item:</span>
                                        <span style="display: block;" class="potential-profit-value {% if net_profit >= 0 %}profit-positive{% else %}profit-negative{% endif %}">
                                            {{ net_profit|floatformat:0|intcomma }}
                                            <span style="font-size: 0.8em; color: #aaa;">(after 2% tax)</span>
                                        </span>
                                    </div>
                                {% endwith %} {# net_profit #}
                            {% endwith %} {# sale_after_tax #}
                        {% endwith %} {# sale_price, acc_price #}
                    {% endif %}

                     {# Last User Tx #}
                    <div style="margin-bottom: 10px;">
                         <span style="display: block; font-weight: bold; color: #ccc;">Latest Activity:</span>
                         <span style="display: block;">
                            {# Use the new, correctly filtered variable #}
                            {% if overall_last_tx_for_item %}
                                {{ overall_last_tx_for_item.date_of_holding|naturaltime }}
                                {# Optional: Show which user made the last transaction #}
                                {% if overall_last_tx_for_item.user %}
                                    (by {{ overall_last_tx_for_item.user.username }})
                                {% endif %}
                            {% else %}
                                - {# Display dash if NO transactions exist at all for this item #}
                            {% endif %}
                         </span>
                    </div>

                </div>
                {# --- END Centered Section --- #}


                {# --- NEW "Your Stats" Section --- #}
                <div class="user-stats-section" style="margin-top: 25px; padding-top: 15px; border-top: 1px solid #444;">
                    <h3 style="text-align: center; margin-bottom: 15px; color: #ddd;">Your Stats</h3>
                    {# Keep original label-value inline display for these #}
                    <div class="info-row"> {# Re-using info-row class might work, or remove if styles conflict #}
                        <p><span class="field-label">Average Sell Price:</span> <span class="field-value">{{ average_sold_price|floatformat:0|intcomma }}</span></p>
                        <p><span class="field-label">Total Sold:</span> <span class="field-value">{{ total_sold|floatformat:0|intcomma }}</span></p>
                        <p><span class="field-label">Current Quantity Holdings:</span> <span class="field-value">{{ remaining_quantity|floatformat:0|intcomma }}</span></p>
                        <p><span class="field-label">Item Realised Profit:</span> <span class="field-value">{{ item_profit|floatformat:0|intcomma }}</span></p>
                        <p><span class="field-label">Global Realised Profit:</span> <span class="field-value">{{ global_realised_profit|floatformat:0|intcomma }}</span></p>
                    </div>
                </div>
                 {# --- END "Your Stats" Section --- #}


                {# Accumulation / Target Price Forms - **** ADMIN ONLY **** (Keep below stats) #}
                {% if user.username == ADMIN_USERNAME %}
                    <div class="admin-only-form" style="margin-top: 20px; padding-top:15px; border-top: 1px solid #444;">
                        <h4 style="text-align: center; color: #ccc; margin-bottom:15px;">Admin Price Update</h4>
                        <form method="post" class="accum-target-form">
                            {% csrf_token %}
                            <input type="hidden" name="acc_item_id" value="{{ item.id }}">
                            <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                            <label for="acc_price">Accumulation Price (M):</label>
                            <input type="number" step="any" name="accumulation_price" id="acc_price" value="{% if accumulation %}{{ accumulation.accumulation_price|divide:1000000|default_if_none:''|floatformat:'-3g' }}{% endif %}">
                            <button type="submit" name="update_accumulation">Update</button>
                        </form>
                        <form method="post" class="accum-target-form">
                            {% csrf_token %}
                            <input type="hidden" name="ts_item_id" value="{{ item.id }}">
                            <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                            <label for="ts_price">Target Sell Price (M):</label>
                            <input type="number" step="any" name="target_sell_price" id="ts_price" value="{% if target_sell %}{{ target_sell.target_sell_price|divide:1000000|default_if_none:''|floatformat:'-3g' }}{% endif %}">
                            <button type="submit" name="update_target_sell">Update</button>
                        </form>
                     </div>
                {% endif %}
                {# ---- END ADMIN ONLY PRICE FORMS ---- #}

            {% else %} {# Corresponds to {% if item %} #}
                 {# Placeholder content when no item is found/searched (Remains the same) #}
                 <div style="text-align:center;">
                     <img src="{% static 'images/rs3_logo.webp' %}" alt="Default Image" class="item-image" style="opacity: 0.5;">
                     <h2>Search Item</h2>
                     <p>Enter an item name or alias above to see details and transaction history.</p>
                     <p><span class="field-label">Global Realised Profit:</span> <span class="field-value">{{ global_realised_profit|floatformat:0|intcomma }}</span></p>
                 </div>
            {% endif %} {# End of {% if item %} #}

        </div> {# <--- End left-panel --> #}

        {# --- RIGHT PANEL --- (No changes needed here based on request) #}
        <div class="right-panel">
            {# ... Form switcher and form containers ... #}
            {# --- Form Switcher Buttons --- #}
            <div class="form-switcher">
                <button type="button" id="showAddTransactionBtn" class="form-switch-btn active">Add Transaction</button>
                <button type="button" id="showPlacingOrderBtn" class="form-switch-btn">Placing Order</button>
            </div>

            {# --- Edit Transaction Form Container --- #}
            {% if edit_form %}
            <div id="editTransactionFormContainer" class="form-container active">
                <div class="transaction-form-section">
                    <h3>Edit Transaction (ID: {{ edit_form.initial.transaction_id }})</h3>
                    <form method="post">
                        {% csrf_token %}
                        <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                        {% if user_page_obj.number %}<input type="hidden" name="user_page" value="{{ user_page_obj.number }}">{% endif %}
                        {{ edit_form.transaction_id }}
                        <div><label for="{{ edit_form.item_name.id_for_label }}">{{ edit_form.item_name.label }}:</label> {{ edit_form.item_name }}</div>
                        <div><label for="{{ edit_form.trans_type.id_for_label }}">{{ edit_form.trans_type.label }}:</label> {{ edit_form.trans_type }}</div>
                        <div><label for="{{ edit_form.price.id_for_label }}">{{ edit_form.price.label }} (M):</label> {{ edit_form.price }}</div>
                        <div><label for="{{ edit_form.quantity.id_for_label }}">{{ edit_form.quantity.label }}:</label> {{ edit_form.quantity }}</div>
                        {% if edit_form.errors %}<div style="color: #ff4d4d; margin-top: 10px;"><strong>Errors:</strong> {{ edit_form.errors }}</div>{% endif %}
                        <div class="submit-section">
                            <button type="submit" name="update_transaction">Update Transaction</button>
                            <a href="{% url 'trades:index' %}?search={{ search_query|urlencode }}{% if user_page_obj.number %}&user_page={{ user_page_obj.number }}{% endif %}" style="margin-left: 10px;">Cancel</a>
                        </div>
                    </form>
                </div>
            </div>
            {% endif %}

            {# --- Add Transaction Form Container --- #}
            <div id="addTransactionFormContainer" class="form-container {% if not edit_form and active_form_name == 'add_transaction' %}active{% endif %}">
                 <div class="transaction-form-section">
                    <h3>Add Transaction</h3>
                     <form method="post" id="addTransactionForm">
                        {% csrf_token %}
                        <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                        {% if user_page_obj.number %}<input type="hidden" name="user_page" value="{{ user_page_obj.number }}">{% endif %}
                        <div><label for="{{ add_transaction_form.item_name.id_for_label }}">{{ add_transaction_form.item_name.label }}:</label> {{ add_transaction_form.item_name }}</div>
                        <div><label for="{{ add_transaction_form.price.id_for_label }}">{{ add_transaction_form.price.label }} (M):</label> {{ add_transaction_form.price }}</div>
                        <div><label for="{{ add_transaction_form.quantity.id_for_label }}">{{ add_transaction_form.quantity.label }}:</label> {{ add_transaction_form.quantity }}</div>
                        <input type="hidden" name="{{ add_transaction_form.trans_type.name }}" id="id_add_trans_type" value="{{ add_transaction_form.trans_type.initial }}">
                        <label>Transaction Type:</label>
                        <div class="trans-type-buttons">
                            <button type="button" class="btn-buy" data-value="Buy" data-form="addTransactionForm">Buy</button>
                            <button type="button" class="btn-sell" data-value="Sell" data-form="addTransactionForm">Sell</button>
                            <button type="button" class="btn-buy" data-value="Instant Buy" data-form="addTransactionForm">Instant Buy</button>
                            <button type="button" class="btn-sell" data-value="Instant Sell" data-form="addTransactionForm">Instant Sell</button>
                        </div>
                        {% if add_transaction_form.errors %}
                            <div style="color: #ff4d4d; margin-top: 10px;"><strong>Errors:</strong>
                                {% for field, errors in add_transaction_form.errors.items %}
                                    <p>{{ field }}: {{ errors|join:", " }}</p>
                                {% endfor %}
                            </div>
                        {% endif %}
                         <div class="submit-section">
                             <button type="submit" name="add_transaction_submit">Add Transaction</button>
                         </div>
                    </form>
                </div>
            </div>

            {# --- Placing Order Form Container --- #}
            <div id="placingOrderFormContainer" class="form-container {% if not edit_form and active_form_name == 'placing_order' %}active{% endif %}">
                  <div class="transaction-form-section">
                    <h3>Placing Order</h3>
                    <form method="post" id="placingOrderForm">
                        {% csrf_token %}
                        <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                         {% if placing_orders_page_obj.number %}<input type="hidden" name="placing_page" value="{{ placing_orders_page_obj.number }}">{% endif %}
                        <div><label for="{{ placing_order_form.item_name.id_for_label }}">{{ placing_order_form.item_name.label }}:</label> {{ placing_order_form.item_name }}</div>
                        <div><label for="{{ placing_order_form.price.id_for_label }}">{{ placing_order_form.price.label }} (M):</label> {{ placing_order_form.price }}</div>
                        <div><label for="{{ placing_order_form.quantity.id_for_label }}">{{ placing_order_form.quantity.label }}:</label> {{ placing_order_form.quantity }}</div>
                        <input type="hidden" name="{{ placing_order_form.trans_type.name }}" id="id_placing_trans_type" value="{{ placing_order_form.trans_type.initial }}">
                        <label>Order Type:</label>
                        <div class="trans-type-buttons">
                            <button type="button" class="btn-buy" data-value="Placing Buy" data-form="placingOrderForm">Placing Buy</button>
                            <button type="button" class="btn-sell" data-value="Placing Sell" data-form="placingOrderForm">Placing Sell</button>
                        </div>
                        {% if placing_order_form.errors %}
                             <div style="color: #ff4d4d; margin-top: 10px;"><strong>Errors:</strong>
                                {% for field, errors in placing_order_form.errors.items %}
                                    <p>{{ field }}: {{ errors|join:", " }}</p>
                                {% endfor %}
                             </div>
                        {% endif %}
                         <div class="submit-section">
                             <button type="submit" name="placing_order_submit">Place Order</button>
                         </div>
                    </form>
                </div>
            </div>

        </div> {# <--- End right-panel --> #}
    </div> {# <--- End content-row --> #}

    {# --- PLACING ORDERS SECTION with Filters --- #}
    <div class="filter-buttons">
        <h2>{{ placing_orders_title }}</h2>
         {# Build URLs preserving other parameters #}
        {% url 'trades:index' as base_url %}
        {% with request.GET.urlencode as current_params %}
             <a href="{{ base_url }}?{% query_transform placing_filter='my' %}"><button class="{% if placing_filter == 'my' %}active{% endif %}">My Orders</button></a>
             <a href="{{ base_url }}?{% query_transform placing_filter='all' %}"><button class="{% if placing_filter == 'all' %}active{% endif %}">All Orders</button></a>
        {% endwith %}
    </div>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    {# ... table headers ... #}
                    <th>ID</th>
                    <th>Item</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Date</th>
                    <th>User</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                {% for order in placing_orders_page_obj %}
                    <tr>
                        {# ... table cells ... #}
                         <td>{{ order.id }}</td>
                        <td>{{ order.item.name }}</td>
                        <td>{{ order.trans_type }}</td>
                        <td>{{ order.price|floatformat:0|intcomma }}</td>
                        <td>{{ order.quantity|floatformat:0|intcomma }}</td>
                         {# Ensure naturaltime is used #}
                        <td class="transaction-time">{{ order.date_of_holding|naturaltime }}</td>
                        <td>{% if order.user %} {{ order.user.username }} {% else %} Unknown {% endif %}</td>
                         <td class="action-buttons">
                             {% if order.user == user or request.user.username == ADMIN_USERNAME %}
                                 <a href="{{ base_url }}?{% query_transform edit_trans=order.id %}">Edit</a> |
                                 <form method="post" style="display:inline;" onsubmit="return confirm('Delete placing order ID {{ order.id }}?');">
                                     {% csrf_token %}
                                     <input type="hidden" name="transaction_id" value="{{ order.id }}">
                                     {# Include necessary hidden fields for context preservation #}
                                     <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                                     <input type="hidden" name="placing_filter" value="{{ placing_filter }}">
                                     <input type="hidden" name="history_filter" value="{{ history_filter }}">
                                     {% if placing_orders_page_obj.number %}<input type="hidden" name="placing_page" value="{{ placing_orders_page_obj.number }}">{% endif %}
                                     {% if user_page_obj.number %}<input type="hidden" name="user_page" value="{{ user_page_obj.number }}">{% endif %}
                                     <button type="submit" name="delete_transaction">Delete</button>
                                 </form>
                             {% else %} N/A {% endif %}
                         </td>
                    </tr>
                {% empty %}
                    <tr><td colspan="8" style="text-align: center;">No placing orders found matching filters.</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {# --- Pagination Controls for Placing Orders --- #}
    <div class="pagination">
        {% if placing_orders_page_obj.has_other_pages %}
            <span class="step-links">
                {% if placing_orders_page_obj.has_previous %}
                    <a href="{{ base_url }}?{% query_transform placing_page=1 %}">&laquo; first</a> {# FIXED #}
                    <a href="{{ base_url }}?{% query_transform placing_page=placing_orders_page_obj.previous_page_number %}">previous</a> {# FIXED #}
                {% endif %}
                <span class="current-page"> Page {{ placing_orders_page_obj.number }} of {{ placing_orders_page_obj.paginator.num_pages }} </span>
                {% if placing_orders_page_obj.has_next %}
                    <a href="{{ base_url }}?{% query_transform placing_page=placing_orders_page_obj.next_page_number %}">next</a>
                    <a href="{{ base_url }}?{% query_transform placing_page=placing_orders_page_obj.paginator.num_pages %}">last &raquo;</a>
                {% endif %}
            </span>
        {% endif %}
    </div>


    {# --- TRANSACTION HISTORY SECTION with Filters --- #}
     <div class="filter-buttons">
        <h2>{{ history_title }}</h2>
        {% url 'trades:index' as base_url %} {# Define base_url if not already defined in this scope #}
        {% with request.GET.urlencode as current_params %} {# You don't actually need current_params if only using query_transform #}
             <a href="{{ base_url }}?{% query_transform history_filter='my' %}"><button class="{% if history_filter == 'my' %}active{% endif %}">My History</button></a>
             <a href="{{ base_url }}?{% query_transform history_filter='all' %}"><button class="{% if history_filter == 'all' %}active{% endif %}">All History</button></a>
        {% endwith %}
    </div>
    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    {# ... table headers ... #}
                    <th>ID</th>
                    <th>Item Name</th>
                    <th>Type</th>
                    <th>Price</th>
                    <th>Quantity</th>
                    <th>Date</th>
                    <th>User</th> {# Added User column #}
                    <th>Realised Profit</th>
                    <th>Cumul. Profit</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
            {% for t in item_transactions %} {# Loop through potentially filtered items #}
                <tr>
                    {# ... table cells ... #}
                    <td>{{ t.id }}</td>
                    <td>{{ t.item.name }}</td>
                    <td>{{ t.trans_type }}</td>
                    <td>{{ t.price|floatformat:0|intcomma }}</td>
                    <td>{{ t.quantity|floatformat:0|intcomma }}</td>
                    {# Ensure naturaltime is used #}
                    <td class="transaction-time">{{ t.date_of_holding|naturaltime }}</td>
                    {# Display User #}
                    <td>{% if t.user %} {{ t.user.username }} {% else %} Unknown {% endif %}</td>
                    <td>{{ t.realised_profit|floatformat:0|intcomma }}</td>
                    <td>{{ t.cumulative_profit|floatformat:0|intcomma }}</td>
                    <td class="action-buttons">
                         {% if t.user == user or request.user.username == ADMIN_USERNAME %}
                             <a href="{{ base_url }}?{% query_transform edit_trans=t.id %}">Edit</a> |
                             <form method="post" style="display:inline;" onsubmit="return confirm('Delete transaction ID {{ t.id }}?');">
                                 {% csrf_token %}
                                 <input type="hidden" name="transaction_id" value="{{ t.id }}">
                                 {# Include necessary hidden fields for context preservation #}
                                 <input type="hidden" name="search" value="{{ search_query|default:'' }}">
                                 <input type="hidden" name="placing_filter" value="{{ placing_filter }}">
                                 <input type="hidden" name="history_filter" value="{{ history_filter }}">
                                 {% if placing_orders_page_obj.number %}<input type="hidden" name="placing_page" value="{{ placing_orders_page_obj.number }}">{% endif %}
                                 {% if user_page_obj.number %}<input type="hidden" name="user_page" value="{{ user_page_obj.number }}">{% endif %}
                                 <button type="submit" name="delete_transaction">Delete</button>
                             </form>
                         {% else %} N/A {% endif %}
                    </td>
                </tr>
            {% empty %}
                <tr><td colspan="10" style="text-align: center;">No transactions found matching filters.</td></tr>
            {% endfor %}
            </tbody>
        </table>
    </div>
    {# --- Pagination Controls for User's Transactions --- #}
    <div class="pagination">
         {% if user_page_obj.has_other_pages %}
             <span class="step-links">
                 {% if user_page_obj.has_previous %}
                     <a href="{{ base_url }}?{% query_transform user_page=1 %}">&laquo; first</a>
                     <a href="{{ base_url }}?{% query_transform user_page=user_page_obj.previous_page_number %}">previous</a>
                 {% endif %}
                 <span class="current-page"> Page {{ user_page_obj.number }} of {{ user_page_obj.paginator.num_pages }} </span>
                 {% if user_page_obj.has_next %}
                     <a href="{{ base_url }}?{% query_transform user_page=user_page_obj.next_page_number %}">next</a>
                     <a href="{{ base_url }}?{% query_transform user_page=user_page_obj.paginator.num_pages %}">last &raquo;</a>
                 {% endif %}
             </span>
         {% endif %}
    </div>

    {# --- Embedded Charts --- #}
    {% if item %}
        <hr style="border-color: #444;">
        <div class="chart-container" style="text-align: center;">
            <h2>Buy/Sell Price Chart (Embedded)</h2>
            <img src="{% url 'trades:item_price_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}"
                 alt="Buy-Sell Price Chart">

            <h2>Item Cumulative Profit (Embedded)</h2>
            <img src="{% url 'trades:item_profit_chart' %}?search={{ search_query|urlencode }}&timeframe={{ timeframe|default:'Daily'|urlencode }}"
                 alt="Item Profit Chart">
        </div>
    {% endif %}

</div> {# End container #}

    {# --- Bootstrap JavaScript Bundle (Needed for alert dismissal AND the auto-close script) --- #}
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" integrity="sha384-geWF76RCwLtnZ8qwWowPQNguL3RmwHVBC9FhGdlKrxdiJJigb/j/68SIy3Te4Bkz" crossorigin="anonymous"></script>

    {# --- Custom JavaScript for Form Switching and Buttons --- #}
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const addTransactionBtn = document.getElementById('showAddTransactionBtn');
            const placingOrderBtn = document.getElementById('showPlacingOrderBtn');
            const addTransactionContainer = document.getElementById('addTransactionFormContainer');
            const placingOrderContainer = document.getElementById('placingOrderFormContainer');
            const editTransactionContainer = document.getElementById('editTransactionFormContainer'); // Get edit container

            const formSwitchButtons = document.querySelectorAll('.form-switch-btn');
            const formContainers = document.querySelectorAll('.right-panel .form-container'); // Select only containers in right panel

            // Function to switch active form
            function switchForm(targetContainer) {
                 // Don't switch if edit form is active
                 if (editTransactionContainer && editTransactionContainer.classList.contains('active')) {
                     return;
                 }

                 formContainers.forEach(container => {
                     container.classList.remove('active');
                 });
                 formSwitchButtons.forEach(button => {
                     button.classList.remove('active');
                 });

                 if (targetContainer) {
                     targetContainer.classList.add('active');
                     // Activate corresponding button
                     if(targetContainer.id === 'addTransactionFormContainer') {
                         addTransactionBtn.classList.add('active');
                     } else if (targetContainer.id === 'placingOrderFormContainer') {
                         placingOrderBtn.classList.add('active');
                     }
                 }
            }

             // Initial state check (only if edit form isn't showing)
             if (!editTransactionContainer) {
                 // Determine which form was active server-side (if neither, default to add)
                 if (placingOrderContainer && placingOrderContainer.classList.contains('active')) {
                     switchForm(placingOrderContainer);
                 } else if (addTransactionContainer) { // Default to add transaction
                     switchForm(addTransactionContainer);
                 }
             } else {
                 // If edit form exists, make sure switch buttons are not active
                 formSwitchButtons.forEach(button => {
                     button.classList.remove('active');
                 });
             }


            // Event Listeners for switching forms (only if edit form is not present)
            if (addTransactionBtn && !editTransactionContainer) {
                addTransactionBtn.addEventListener('click', () => switchForm(addTransactionContainer));
            }
            if (placingOrderBtn && !editTransactionContainer) {
                placingOrderBtn.addEventListener('click', () => switchForm(placingOrderContainer));
            }

            // --- Transaction Type Button Logic ---
            const transTypeButtons = document.querySelectorAll('.trans-type-buttons button');

            transTypeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const value = this.dataset.value;
                    const formId = this.dataset.form; // Get which form this button belongs to
                    const formElement = document.getElementById(formId);
                    const hiddenInput = formElement.querySelector('input[type="hidden"][name="trans_type"]'); // Find the hidden input within that form

                    if (hiddenInput) {
                        hiddenInput.value = value; // Set the hidden input's value

                        // Update button visual state (within the same group)
                        const parentButtonDiv = this.closest('.trans-type-buttons');
                        parentButtonDiv.querySelectorAll('button').forEach(btn => {
                            btn.classList.remove('selected');
                        });
                        this.classList.add('selected');
                    } else {
                        console.error("Hidden trans_type input not found for form:", formId);
                    }
                });

                // Set initial 'selected' state based on hidden input value
                 const formId = button.dataset.form;
                 const formElement = document.getElementById(formId);
                 const hiddenInput = formElement.querySelector('input[type="hidden"][name="trans_type"]');
                 if (hiddenInput && button.dataset.value === hiddenInput.value) {
                     button.classList.add('selected');
                 }
            });

            // --- Auto-Dismissing Alerts ---
            const autoDismissAlerts = document.querySelectorAll('.alert.alert-dismissible');
            const dismissTimeout = 5000; // 5 seconds

            autoDismissAlerts.forEach(function(alertElement) {
                setTimeout(function() {
                    const alertInstance = bootstrap.Alert.getOrCreateInstance(alertElement);
                    if (alertInstance) {
                        alertInstance.close();
                    }
                }, dismissTimeout);
            });
        });
    </script>
    {# --- End Custom JavaScript --- #}

</body>
</html>